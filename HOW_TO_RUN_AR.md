# 🚀 كيفية تشغيل النظام

## ⚠️ مهم جداً

النظام يتكون من **عمليتين منفصلتين** يجب أن يعملا **في نفس الوقت**:

1. **Watcher** - يراقب البيانات الجديدة ويضيف Jobs كل دقيقة
2. **Worker** - يعالج الـ Jobs ويولد ملفات PDF بشكل مستمر

---

## 📋 طرق التشغيل

### ✅ الطريقة الأولى: تشغيل الاثنين معاً (موصى بها)

```
انقر نقراً مزدوجاً على: start_both.vbs
```

سيتم تشغيل Watcher و Worker معاً في الخلفية.

---

### ✅ الطريقة الثانية: تشغيل كل واحد على حدة

#### 1. تشغيل Watcher
```
انقر نقراً مزدوجاً على: start_watcher.vbs
```

#### 2. تشغيل Worker
```
انقر نقراً مزدوجاً على: start_worker.vbs
```

---

## 🔍 مراقبة النظام

### Watcher Log
```
logs/watcher_runner.log
```

### Worker Log
```
logs/worker_runner.log
```

---

## ⏱️ التوقيتات

- **Watcher**: يعمل كل **دقيقة واحدة**
- **Worker**: يعمل كل **10 ثواني** (يتحقق من Jobs جديدة)

---

## 🛑 إيقاف النظام

افتح **Task Manager** واقتل العمليات:
- `php.exe` (watcher_runner.php)
- `php.exe` (worker_runner.php)

أو استخدم:
```powershell
taskkill /F /IM php.exe
```

---

## 🔧 استكشاف الأخطاء

### المشكلة: Watcher شغال لكن Worker مش بيشتغل

**السبب**: Worker بياخد وقت طويل في توليد PDF

**الحل**: 
- تأكد إن الاثنين شغالين في processes منفصلة
- افحص `logs/worker_runner.log`

### المشكلة: لا يوجد Jobs جديدة

**السبب**: Watcher محتاج 1000 صف جديد على الأقل

**الحل**: انتظر حتى يتوفر 1000 صف جديد في جدول `0_stock_moves`

---

## ✨ ملاحظات

- الـ **Lock Files** تمنع التشغيل المتزامن لنفس الـ process
- Watcher Lock: `watcher.lock` (مدة 2 دقيقة)
- Worker Lock: `worker.lock` (مدة 10 دقائق)
- إذا حدث crash، الـ lock files ستُحذف تلقائياً بعد انتهاء المدة

---

## 📊 مثال على سير العمل

```
الوقت 00:00 → Watcher يفحص البيانات → يضيف 3 Jobs جديدة
الوقت 00:00 → Worker يبدأ معالجة Job #1 (يستغرق 5 دقائق)
الوقت 00:01 → Watcher يفحص البيانات مرة أخرى (Worker لا يزال يعمل)
الوقت 00:05 → Worker ينتهي من Job #1 → يبدأ Job #2
الوقت 00:02 → Watcher يفحص البيانات (Worker لا يزال يعمل)
...
```

**الفائدة**: Watcher و Worker يعملان **بشكل مستقل** دون انتظار بعضهما البعض!
