# ๐ ุดุฑุญ ุชูุตููู ูููุดุฑูุน - TCPDF Job Queue System

## ๐ฏ ุงููุฏู ูู ุงููุดุฑูุน

ุชุญููู ุจูุงูุงุช ุญุฑูุงุช ุงููุฎุฒูู ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช ุฅูู ุชูุงุฑูุฑ PDF ุจุดูู **ุชููุงุฆู ูููุธู**ุ ูุน ูุนุงูุฌุฉ ุขูุงู ุงูุณุฌูุงุช ุจููุงุกุฉ ุนุงููุฉ.

---

## ๐ ููู ูุนูู ุงููุธุงูุ

### ุงููุฑุงุญู ุงูุฃุณุงุณูุฉ:

```
1. Watcher (ุงููุฑุงูุจ) ๐๏ธ
   โ
2. Job Queue (ุทุงุจูุฑ ุงูููุงู) ๐
   โ
3. Worker (ุงููุนุงูุฌ) โ๏ธ
   โ
4. PDF Reports (ุงูุชูุงุฑูุฑ) ๐
```

---

## ๐ ุดุฑุญ ุชูุตููู ููู ูุฑุญูุฉ

### 1๏ธโฃ Watcher (ุงููุฑุงูุจ) - `scripts/watcher.php`

**ุงููุธููุฉ:** ุงูุจุญุซ ุนู ุจูุงูุงุช ุฌุฏูุฏุฉ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช

#### ููู ูุนููุ

```php
// ูู 5 ุฏูุงุฆูุ ููุญุต ุงูุฌุฏูู
SELECT MAX(trans_id) FROM stock_moves;

// ูุซุงู:
ุขุฎุฑ ูุนุงูุฌุฉ: 4500299
ุฃุญุฏุซ ุจูุงูุงุช: 4501003
ุจูุงูุงุช ุฌุฏูุฏุฉ: 704 ุณุฌู โ

// ุฅุฐุง ูุตู ุงูุนุฏุฏ 1000 ุณุฌู:
ุฅูุดุงุก Job ุฌุฏูุฏ ูู ุงูุทุงุจูุฑ
```

#### ุงูููุฏ ุงูุฃุณุงุณู:

```php
// 1. ุฌูุจ ุขุฎุฑ trans_id ุชู ูุนุงูุฌุชู
$lastProcessed = $db->getLastProcessedTransId();

// 2. ุฌูุจ ุฃุญุฏุซ trans_id ูู ุงูุฌุฏูู
$currentMax = $db->getCurrentMaxTransId();

// 3. ุญุณุงุจ ุงููุฑู
$newRows = $currentMax - $lastProcessed;

// 4. ุฅุฐุง ูุตู 1000 ุณุฌูุ ุฅูุดุงุก Jobs
if ($newRows >= 1000) {
    while ($lastProcessed + 1000 <= $currentMax) {
        $startId = $lastProcessed + 1;
        $endId = $lastProcessed + 1000;
        
        // ุฅุถุงูุฉ ุงููููุฉ ุฅูู ุงูู Queue
        $jobId = $db->addQueueJob($startId, $endId);
        
        echo "[โ] Created job #$jobId: trans_id $startId to $endId\n";
        
        // ุชุญุฏูุซ ุขุฎุฑ ูุนุงูุฌุฉ
        $db->saveLastProcessedId($endId, 1000);
        $lastProcessed = $endId;
    }
}
```

---

### 2๏ธโฃ Job Queue (ุทุงุจูุฑ ุงูููุงู) - ุฌุฏูู `jobs`

**ุงููุธููุฉ:** ุชูุธูู ุงูููุงู ูุชุชุจุน ุญุงูุชูุง

#### ุจููุฉ ุงูุฌุฏูู:

```sql
CREATE TABLE jobs (
    id INT PRIMARY KEY AUTO_INCREMENT,
    start_trans_id INT NOT NULL,
    end_trans_id INT NOT NULL,
    status VARCHAR(50) DEFAULT 'pending',
    worker_id VARCHAR(50) DEFAULT NULL,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

#### ุญุงูุงุช ุงูู Job:

| ุงูุญุงูุฉ | ุงููุตู | ุงูุฃููููุฉ |
|--------|-------|----------|
| `pending` | ูู ุงูุชุธุงุฑ ุงููุนุงูุฌุฉ | โณ |
| `processing` | ุฌุงุฑู ุงููุนุงูุฌุฉ ุงูุขู | โ๏ธ |
| `done` | ุชู ุงูุงูุชูุงุก ุจูุฌุงุญ | โ |
| `failed` | ูุดูุช ุงููุนุงูุฌุฉ | โ |

---

### 3๏ธโฃ Worker (ุงููุนุงูุฌ) - `scripts/worker.php`

**ุงููุธููุฉ:** ูุนุงูุฌุฉ ุงูููุงู ูุชูููุฏ ุชูุงุฑูุฑ PDF

#### ุฎุทูุงุช ุงููุนุงูุฌุฉ:

```php
public function processJob($job) {
    // 1. ุชุญุฏูุซ ุงูุญุงูุฉ ุฅูู "processing"
    $this->db->updateJobStatus($jobId, 'ุชุชู ูุนุงูุฌุฉ ุงูุนูููุงุช');
    
    // 2. ุฌูุจ ุงูุจูุงูุงุช ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
    $data = $this->db->getStockMovesByRange($startTransId, $endTransId);
    
    // 3. ุชูููุฏ ุชูุฑูุฑ PDF
    $filepath = ReportGenerator::generate($data, $startTransId, $endTransId);
    
    // 4. ุญูุธ ูุนูููุงุช ุงูุชูุฑูุฑ
    $this->db->saveReportBatch($startTransId, $endTransId, $filepath);
    
    // 5. ุชุญุฏูุซ ุงูุญุงูุฉ ุฅูู "done"
    $this->db->updateJobStatus($jobId, 'ุชู ูุนุงูุฌุฉ ุงูุนูููุงุช');
}
```

---

### 4๏ธโฃ Report Generator (ูููุฏ ุงูุชูุงุฑูุฑ)

**ุงููุธููุฉ:** ุชุญููู ุงูุจูุงูุงุช ุฅูู PDF ููุณู

```php
// 1. ุฅูุดุงุก PDF
$pdf = new TCPDF('L', 'mm', 'A4', true, 'UTF-8');

// 2. ุฅุถุงูุฉ ุตูุญุฉ
$pdf->AddPage();

// 3. ุงูุนููุงู
$pdf->SetFont('dejavusans', 'B', 14);
$pdf->Cell(0, 10, 'ุชูุฑูุฑ ุญุฑูุงุช ุงููุฎุฒูู', 0, 1, 'C');

// 4. ุจูุงุก ุฌุฏูู HTML
$html = '<table>...</table>';

// 5. ูุชุงุจุฉ HTML ูู PDF
$pdf->writeHTML($html);

// 6. ุญูุธ ุงูููู
$pdf->Output("reports/stock_move_{$startId}_{$endId}.pdf", 'F');
```

---

## ๐๏ธ ูุงุนุฏุฉ ุงูุจูุงูุงุช

### ุงูุฌุฏุงูู ุงูุฃุณุงุณูุฉ:

#### 1. `stock_moves` - ุงูุจูุงูุงุช ุงูุฃุตููุฉ
```sql
trans_id | trans_no | type | stock_id | tran_date  | qty | price
---------|----------|------|----------|------------|-----|-------
4500300  | SM001    | 13   | ITEM001  | 2025-10-26 | 100 | 50.00
```

#### 2. `jobs` - ุทุงุจูุฑ ุงูููุงู
```sql
id | start_trans_id | end_trans_id | status  | created_at
---|----------------|--------------|---------|------------
1  | 4500300        | 4501299      | done    | 2025-10-26
```

#### 3. `report_batches` - ุณุฌู ุงูุชูุงุฑูุฑ
```sql
id | start_trans_id | end_trans_id | pdf_path
---|----------------|--------------|----------------------------------
1  | 4500300        | 4501299      | reports/stock_move_4500300_4501299.pdf
```

#### 4. `system_log` - ุณุฌู ุงููุธุงู
```sql
id | level   | message              | job_id | created_at
---|---------|----------------------|--------|------------
1  | INFO    | Watcher started      | NULL   | 2025-10-26
2  | SUCCESS | Job #1 completed     | 1      | 2025-10-26
```

---

## โ๏ธ ุงูุชุดุบูู ุงูุชููุงุฆู

### ุงูุทุฑููุฉ: Task Scheduler

```
Windows Startup
   โ
Task Scheduler
   โ
start_system_silent.vbs
   โ
start_system.bat
   โ
ุญููุฉ ูุง ููุงุฆูุฉ:
  โโโ watcher.php (ูู 5 ุฏูุงุฆู)
  โโโ worker.php (ูู 5 ุฏูุงุฆู)
  โโโ ุฅุนุงุฏุฉ โป
```

---

## ๐ ูุซุงู ุนููู

```
10:00 - Watcher ููุญุต
โโโ ุขุฎุฑ ูุนุงูุฌุฉ: 4500299
โโโ ุฃุญุฏุซ ุจูุงูุงุช: 4500850
โโโ ุงููุฑุงุฑ: โธ๏ธ ุงูุชุธุงุฑ (551 ุณุฌู)

10:05 - Watcher ููุญุต
โโโ ุขุฎุฑ ูุนุงูุฌุฉ: 4500299
โโโ ุฃุญุฏุซ ุจูุงูุงุช: 4501350
โโโ ุงููุฑุงุฑ: โ ุฅูุดุงุก Job #1

10:06 - Worker ูุนุงูุฌ
โโโ ุฌูุจ 1000 ุณุฌู
โโโ ุชูููุฏ PDF
โโโ ุญูุธ: stock_move_4500300_4501299.pdf โ
```

---

## ๐ ุจููุฉ ุงููููุงุช

```
tcpdf_job_queue_stock_moves_v2/
โโโ scripts/
โ   โโโ watcher.php
โ   โโโ worker.php
โโโ classes/
โ   โโโ Database.php
โ   โโโ JobWatcher.php
โ   โโโ JobWorker.php
โ   โโโ ReportGenerator.php
โโโ reports/
โ   โโโ stock_move_*.pdf
โโโ dashboard.php
โโโ start_system.bat
```

---

## ๐ฏ ุงูุฎูุงุตุฉ

### ุงููุธุงู ูุนูู ุจูุฐุง ุงูุดูู:

1. **Watcher** ูุฑุงูุจ ูุงุนุฏุฉ ุงูุจูุงูุงุช ูู 5 ุฏูุงุฆู
2. ุนูุฏ ูุตูู **1000 ุณุฌู ุฌุฏูุฏ**ุ ููุดุฆ **Job**
3. **Worker** ูุฃุฎุฐ ุงูู Job ููุนุงูุฌู
4. ูุฌูุจ **1000 ุณุฌู** ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
5. ูููุฏ **ููู PDF** ููุธู
6. ูุญูุธ ุงูููู ูู `reports/`
7. ูุณุฌู ูู ุดูุก ูู `system_log`
8. **ููุฑุฑ** ุงูุนูููุฉ ุชููุงุฆูุงู

### ุงููููุฒุงุช:
- โ ุชููุงุฆู ุจุงููุงูู
- โ ููุธู (1000 ุณุฌู = 1 PDF)
- โ ููุซูู (ุชุณุฌูู ูุงูู)
- โ ูุงุจู ููุชูุณุน

---

**ุชู ุฅูุดุงุก ูุฐุง ุงูููู ูู: 26 ุฃูุชูุจุฑ 2025**
